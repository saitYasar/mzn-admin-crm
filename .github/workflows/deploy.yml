name: 00 - Preflight (No-Fail)

on:
  workflow_dispatch:

permissions:
  id-token: write # OIDC token testini yapmak iÃ§in gerekli
  contents: read

jobs:
  preflight:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: â„¹ï¸ Context
        run: |
          echo "Repo:  $GITHUB_REPOSITORY"
          echo "Ref:   $GITHUB_REF"
          echo "SHA:   $GITHUB_SHA"
          echo "Actor: $GITHUB_ACTOR"
          echo "Runner OS: $(uname -a)"
          echo "Node: $(node -v 2>/dev/null || echo 'yok')" 
          echo "npm:  $(npm -v 2>/dev/null || echo 'yok')"

      - name: ğŸ” Secrets var mÄ±? (maskeli gÃ¶stergeler)
        run: |
          set +e
          mask_hash () { test -n "$1" && printf "%s" "$1" | sha256sum | cut -c1-8 || echo "<yok>"; }
          echo "VERCEL_TOKEN len: ${#VERCEL_TOKEN:-0} hash8: $(mask_hash "$VERCEL_TOKEN")"
          echo "VERCEL_PROJECT_ID len: ${#VERCEL_PROJECT_ID:-0} hash8: $(mask_hash "$VERCEL_PROJECT_ID")"
          echo "VERCEL_ORG_ID len: ${#VERCEL_ORG_ID:-0} hash8: $(mask_hash "$VERCEL_ORG_ID")"
          echo "INFISICAL_DOMAIN: ${INFISICAL_DOMAIN:-<yok>}"
          echo "INFISICAL_IDENTITY_ID len: ${#INFISICAL_IDENTITY_ID:-0} hash8: $(mask_hash "$INFISICAL_IDENTITY_ID")"
          echo "âœ… Bu adÄ±m sadece var/yok bilgisini loglar; gerÃ§ek deÄŸerler maskelenir. deneme"

      - name: ğŸŒ Infisical domain DNS & HTTP kontrol
        run: |
          set +e
          if [ -z "${INFISICAL_DOMAIN:-}" ]; then
            echo "âš ï¸ INFISICAL_DOMAIN yok; aÄŸ testleri atlandÄ±."
          else
            HOST=$(echo "$INFISICAL_DOMAIN" | sed -E 's#^https?://##' | cut -d/ -f1)
            echo "Test edilecek host: $HOST"
            echo "DNS:"
            getent hosts "$HOST" || echo "âš ï¸ DNS Ã§Ã¶zÃ¼mlemesi baÅŸarÄ±sÄ±z olabilir."
            echo "HTTP HEAD:"
            curl -sS -I --max-time 8 "$INFISICAL_DOMAIN" | sed -n '1,5p' || echo "âš ï¸ HTTP eriÅŸimi baÅŸarÄ±sÄ±z olabilir."
          fi

      - name: ğŸ” OIDC token mint (sadece uzunluk/log)
        run: |
          set +e
          if [ -z "${ACTIONS_ID_TOKEN_REQUEST_URL:-}" ] || [ -z "${ACTIONS_ID_TOKEN_REQUEST_TOKEN:-}" ]; then
            echo "âš ï¸ Runner OIDC deÄŸiÅŸkenleri yok gibi."
          else
            # audience serbest; Infisical tarafÄ±nda Ã§oÄŸunlukla Ã¶nemli deÄŸil, 'infisical' diyelim
            RESP=$(curl -sS -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
              "$ACTIONS_ID_TOKEN_REQUEST_URL&audience=infisical")
            TOK=$(echo "$RESP" | jq -r '.value' 2>/dev/null)
            if [ -n "$TOK" ] && [ "$TOK" != "null" ]; then
              echo "âœ… OIDC token alÄ±ndÄ±. Uzunluk: ${#TOK}"
            else
              echo "âš ï¸ OIDC token alÄ±namadÄ±. YanÄ±t:"
              echo "$RESP" | head -n 20
            fi
          fi

      - name: ğŸ“¦ Vercel CLI kurulumu
        run: |
          set +e
          npm i -g vercel@latest >/dev/null 2>&1 && echo "âœ… vercel kuruldu" || echo "âš ï¸ vercel kurulamadÄ±"
          vercel --version || true

      - name: ğŸ—‚ï¸ .vercel/project.json (varsa) oku - maskeli
        run: |
          set +e
          if [ -f ".vercel/project.json" ]; then
            echo "Bulundu: .vercel/project.json"
            ORG=$(jq -r '.orgId' .vercel/project.json 2>/dev/null)
            PRJ=$(jq -r '.projectId' .vercel/project.json 2>/dev/null)
            # Maskeli gÃ¶ster
            short() { test -n "$1" && echo "${1:0:6}******" || echo "<yok>"; }
            echo "orgId: $(short "$ORG")"
            echo "projectId: $(short "$PRJ")"
          else
            echo "â„¹ï¸ .vercel/project.json yok."
          fi

      - name: âœ… SonuÃ§
        run: |
          echo "Preflight tamamlandÄ±. HiÃ§bir adÄ±m hata ile durdurulmadÄ±."
          echo "ğŸ” LoglarÄ± inceleyip eksik noktalarÄ± sÄ±rayla kapatacaÄŸÄ±z."
